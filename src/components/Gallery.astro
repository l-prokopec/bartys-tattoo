---
export type GalleryImage = {
  src: string;
  alt?: string;
  width?: number;
  height?: number;
};

const { images = [], label = 'Galerie' } = Astro.props as {
  images: GalleryImage[];
  label?: string;
};
---

<div class="portfolio-gallery" aria-label={label}>
  <button
    class="portfolio-gallery__arrow portfolio-gallery__arrow--prev"
    type="button"
    aria-label="Předchozí obrázek"
  >
    ←
  </button>

  <div class="portfolio-gallery__track">
    {images.map((image, index) => {
      const isLandscape =
        typeof image.width === 'number' &&
        typeof image.height === 'number' &&
        image.width >= image.height;

      return (
        <figure class={`portfolio-gallery__item${isLandscape ? ' is-landscape' : ''}`}>
          <img
            src={image.src}
            alt={image.alt ?? `Portfolio ukázka ${index + 1}`}
            loading="lazy"
            class="portfolio-gallery__image"
          />
        </figure>
      );
    })}
  </div>

  <button
    class="portfolio-gallery__arrow portfolio-gallery__arrow--next"
    type="button"
    aria-label="Další obrázek"
  >
    →
  </button>
</div>

<script is:inline>
  (function () {
    function getCenteredScrollLeft(trackEl, itemEl) {
      return itemEl.offsetLeft - (trackEl.clientWidth - itemEl.clientWidth) / 2;
    }

    function scrollToItem(trackEl, itemEl) {
      trackEl.scrollTo({
        left: getCenteredScrollLeft(trackEl, itemEl),
        behavior: 'smooth'
      });
    }

    function initGallery(gallery) {
      if (!(gallery instanceof HTMLElement)) return;
      if (gallery.dataset.galleryReady === 'true') return;

      var track = gallery.querySelector('.portfolio-gallery__track');
      var prevBtn = gallery.querySelector('.portfolio-gallery__arrow--prev');
      var nextBtn = gallery.querySelector('.portfolio-gallery__arrow--next');

      if (!track || !(track instanceof HTMLElement)) return;

      var items = Array.prototype.slice
        .call(track.querySelectorAll('.portfolio-gallery__item'))
        .filter(function (el) {
          return el instanceof HTMLElement;
        });

      if (items.length <= 1) {
        if (prevBtn) prevBtn.setAttribute('hidden', 'true');
        if (nextBtn) nextBtn.setAttribute('hidden', 'true');
        gallery.dataset.galleryReady = 'true';
        return;
      }

      var ticking = false;
      var activeIndex = 0;

      function updateArrows() {
        if (!(prevBtn instanceof HTMLButtonElement) || !(nextBtn instanceof HTMLButtonElement)) return;
        if (activeIndex <= 0) prevBtn.setAttribute('hidden', 'true');
        else prevBtn.removeAttribute('hidden');

        if (activeIndex >= items.length - 1) nextBtn.setAttribute('hidden', 'true');
        else nextBtn.removeAttribute('hidden');
      }

      function updateActive() {
        var center = track.scrollLeft + track.clientWidth / 2;
        var closestIndex = 0;
        var minDistance = Infinity;

        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          var itemCenter = item.offsetLeft + item.clientWidth / 2;
          var distance = Math.abs(center - itemCenter);
          if (distance < minDistance) {
            minDistance = distance;
            closestIndex = i;
          }
        }

        items.forEach(function (item) {
          item.classList.remove('is-active', 'is-left', 'is-right');
        });

        var active = items[closestIndex];
        if (!active) return;

        activeIndex = closestIndex;
        active.classList.add('is-active');
        if (items[closestIndex - 1]) items[closestIndex - 1].classList.add('is-left');
        if (items[closestIndex + 1]) items[closestIndex + 1].classList.add('is-right');
      }

      function requestTick() {
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(function () {
          ticking = false;
          updateActive();
          updateArrows();
        });
      }

      function scrollByItem(direction) {
        var active = track.querySelector('.portfolio-gallery__item.is-active');
        var currentIndex = items.indexOf(active);
        if (currentIndex === -1) currentIndex = 0;
        var target = items[currentIndex + direction];
        if (!(target instanceof HTMLElement)) return;
        scrollToItem(track, target);
      }

      if (prevBtn instanceof HTMLButtonElement) {
        prevBtn.removeAttribute('hidden');
        prevBtn.addEventListener('click', function () {
          scrollByItem(-1);
        });
      }

      if (nextBtn instanceof HTMLButtonElement) {
        nextBtn.removeAttribute('hidden');
        nextBtn.addEventListener('click', function () {
          scrollByItem(1);
        });
      }

      track.addEventListener('scroll', requestTick, { passive: true });
      window.addEventListener('resize', requestTick);

      requestAnimationFrame(function () {
        updateActive();
        updateArrows();
      });

      gallery.dataset.galleryReady = 'true';
    }

    var gallery = document.currentScript && document.currentScript.previousElementSibling;
    if (gallery && gallery.classList.contains('portfolio-gallery')) {
      initGallery(gallery);
      return;
    }

    document.querySelectorAll('.portfolio-gallery').forEach(initGallery);
  })();
</script>
